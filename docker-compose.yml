name: Deploy to Apache Server

on:
  push:
    branches:
      - main  # Trigger deployment on push to the main branch (or your desired branch)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'  # Adjust to the version of Node.js you need

    - name: Install Dependencies
      run: |
        # Install dependencies using npm or yarn (depends on your setup)
        npm install  # Or use yarn install if you're using Yarn

    - name: Build the React App
      run: |
        # Build the React app (or your front-end project)
        npm run build  # Adjust if you're using yarn (e.g., yarn build)

    - name: Install SSH and SCP Tools
      run: |
        # Install sshpass for non-interactive SSH password authentication
        sudo apt-get install -y sshpass

    - name: Transfer Files to Apache Server using SCP
      run: |
        # Use SCP to copy the built files to the Apache server
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -r ./build/* ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/var/www/html/

    - name: SSH into Apache Server to Set Permissions and Restart Apache
      run: |
        # SSH into the server to set proper permissions and restart Apache if needed
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          # Set appropriate permissions for the files (optional but recommended)
          sudo chown -R www-data:www-data /var/www/html/*
          sudo chmod -R 755 /var/www/html/*
          
          # Restart Apache to ensure the new content is served
          sudo systemctl restart apache2
        "
