name: Deploy Web App to Apache Server

on:
  push:
    branches:
      - main  # Runs only when code is pushed to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install SSH & SSHPass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Debug SSH Variables
      run: |
        echo "Server Host: 95.111.218.189"
        echo "Server Username: root"

    - name: Install Dependencies (Express.js)
      run: |
        export CI=false  # Prevent ESLint warnings from failing build
        npm install

    - name: Transfer Express.js App to Server
      env:
        SERVER_HOST: 95.111.218.189
        SERVER_USERNAME: root
        SERVER_PASSWORD: navdeep123
      run: |
        sshpass -p "$SERVER_PASSWORD" ssh -tt -o StrictHostKeyChecking=no $SERVER_USERNAME@$SERVER_HOST << 'EOF'
          echo "Successfully connected to $SERVER_HOST"
          # Remove old project files (optional)
          rm -rf /var/www/express-app/
          mkdir -p /var/www/express-app/
        EOF
        
        # Copy all project files to the server
        sshpass -p "$SERVER_PASSWORD" scp -r * $SERVER_USERNAME@$SERVER_HOST:/var/www/express-app/

    - name: Restart Express.js Server with PM2
      env:
        SERVER_HOST: 95.111.218.189
        SERVER_USERNAME: root
        SERVER_PASSWORD: navdeep123
      run: |
        sshpass -p "$SERVER_PASSWORD" ssh -tt -o StrictHostKeyChecking=no $SERVER_USERNAME@$SERVER_HOST << 'EOF'
          echo "Restarting Express.js app..."
          cd /var/www/express-app/
          npm install
          pm2 restart subway-app || pm2 start app.js --name subway-app
          pm2 save
        EOF
