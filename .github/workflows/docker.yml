name: Deploy Web App to Apache Server

on:
  push:
    branches:
      - main  # Runs only when code is pushed to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Install SSH & SSHPass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Debug SSH Variables
      run: |
        echo "Server Host: 95.111.218.189"
        echo "Server Username: root"

    - name: Install Dependencies & Build React App
      run: |
        export CI=false  # Prevent ESLint warnings from failing build
        npm install
        npm run build

    - name: Transfer Files to Apache Server
      env:
        SERVER_HOST: 95.111.218.189
        SERVER_USERNAME: root
        SERVER_PASSWORD: navdeep123
      run: |
        sshpass -p "$SERVER_PASSWORD" ssh -tt -o StrictHostKeyChecking=no $SERVER_USERNAME@$SERVER_HOST << 'EOF'
          echo "Successfully connected to $SERVER_HOST"
          rm -rf /var/www/html/*
        EOF
        
        sshpass -p "$SERVER_PASSWORD" scp -r build/* $SERVER_USERNAME@$SERVER_HOST:/var/www/html/

    - name: Restart Apache Server
      env:
        SERVER_HOST: 95.111.218.189
        SERVER_USERNAME: root
        SERVER_PASSWORD: navdeep123
      run: |
        sshpass -p "$SERVER_PASSWORD" ssh -tt -o StrictHostKeyChecking=no $SERVER_USERNAME@$SERVER_HOST << 'EOF'
          echo "Restarting Apache..."
          sudo systemctl restart apache2
        EOF
